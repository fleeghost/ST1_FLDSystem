<!--
 * @Description: In User Settings Edit
 * @Author: your name
 * @Date: 2019-08-02 19:22:13
 * @LastEditTime: 2019-08-02 19:22:13
 * @LastEditors: your name
 -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>福路德信息化平台</title>
    <link rel="stylesheet" href="assets/layui/css/layui.css" media="all">
    <link rel="stylesheet" type="text/css" href="assets/element-ui/theme-chalk/index.css" />
    <link rel="stylesheet" type="text/css" href="assets/utils/base.css" />
    <link rel="stylesheet" type="text/css" href="assets/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="assets/iconfont/iconfont.css" />
    <script type="text/javascript" src="assets/jquery/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="assets/jquery/ajaxuploadfile.js"></script>
    <script type="text/javascript" src="assets/layer/layer.js"></script>
    <script type="text/javascript" src="assets/layui/layui.js"></script>
    <script type="text/javascript" src="assets/vue/vue.js"></script>
    <script type="text/javascript" src="assets/element-ui/index.js"></script>
    <script type="text/javascript" src="assets/vue/vue-element-bigdata-table.min.js"></script>
    <!-- 软件报错信息记录脚本 -->
    <script type="text/javascript" src="assets/utils/appError.js"></script>
    <!-- 获取本机IP地址的脚本 -->
    <script type="text/javascript" src="assets/utils/getIPAdress.js"></script>
    <!-- element ui menu组件二次封装 -->
    <script type="text/javascript" src="assets/utils/vue-tree.js"></script>


    <style>
        .iconfont {
            font-size: 20px;
        }

        .el-container {
            height: 100%;
            font-size: 12px;
        }

        .el-container .el-header {
            height: auto !important;
            padding: 0 !important;

        }

        .el-container .el-header .row-1 {
            background: #b91727;
            padding: 0 0 0 20px;
            overflow: hidden;
            color: #fff;
            -webkit-app-region: drag;
        }

        .el-container .el-header .row-1 .logo {
            float: left;
            font-size: 16px;
            font-weight: 700;
            padding: 5px 0;
        }

        .el-container .el-header .row-1 .logo img,
        .el-container .el-header .row-1 .logo span {
            vertical-align: middle;
        }

        .el-container .el-header .row-1 .system-operation {
            float: right;
            height: 40px;
            line-height: 40px;
            overflow: hidden;
            font-size: 20px;
            -webkit-app-region: no-drag;
        }

        .el-container .el-header .row-1 .system-operation .item {
            cursor: pointer;
            vertical-align: top;
            height: 40px;
            float: left;
            font-size: 12px;
        }

        .el-container .el-header .row-1 .system-operation .item:hover {
            background: rgba(255, 255, 255, .2);
        }

        .el-container .el-header .row-1 .system-operation .item>i {
            padding: 0 8px;
        }

        .el-container .el-header .row-1 .system-operation .item .el-dropdown-selfdefine {
            padding: 0 8px;
        }

        .el-container .el-header .row-1 .system-operation .img {
            padding: 0 8px 0 12px;
        }

        .el-container .el-header .row-1 .system-operation .img img {
            width: 30px;
            height: 30px;
            border-radius: 15px;
            margin-top: 5px;
            vertical-align: top;
        }

        .el-container .el-header .row-2 {
            background: #1e2226;
            color: #fff;
            position: relative;
            overflow: hidden;
        }

        .el-container .el-header .row-3 {
            background: #e5e5e5;
            color: #000;
            position: relative;
            overflow: hidden;
        }

        .el-container .el-header .el-tabs--border-card {
            background: transparent;
            border: 0;
            -webkit-box-shadow: none;
            box-shadow: none;
        }

        .el-container .el-header .el-tabs--border-card>.el-tabs__header .el-tabs__item:not(.is-disabled):hover {
            background: #404346;
            border-right-color: #404346;
            border-left-color: #404346;
            color: #fff;
        }

        .el-container .el-header .el-tabs--border-card>.el-tabs__header .el-tabs__item.is-active {
            background: #404346;
            border-right-color: #404346;
            border-left-color: #404346;
            color: #fff;
        }

        .el-container .el-header .el-tabs__content {
            display: none
        }

        .el-container .tree-search {
            font-size: 13px;
        }

        .el-container .tree-search button {
            min-width: 24px;
            text-align: center;
        }

        .el-container .tree-search .el-button--text {
            color: #606266;
            margin: 0;
        }

        .el-container .tree-search .search-text {
            display: inline-block;
            height: 28px;
            line-height: 28px;
            margin-left: 0;
        }

        .el-container .tree-search .search-text input {
            border: 1px solid #c7c7c7;
            margin: 0;
            padding: 0 10px 0;
            width: 100px;
            height: 22px;
            border-radius: 11px;
            background: #c7c7c7;
            outline: none;
            color: #606266;
        }

        .el-container .tree-search .el-input-group__append {
            padding: 0 5px;
            cursor: pointer;
        }

        .el-container .el-aside {
            background: #1e2226;
            width: auto !important;
        }



        .el-container .el-aside .tree-list {
            height: 100%;
            overflow-y: auto;
        }

        .bg-opacity {
            background: rgba(255, 255, 255, .03);
        }

        .el-menu--vertical {
            background: rgba(30, 34, 38, .97);
        }

        .el-menu {
            border: 0;
        }

        .el-submenu__title {
            height: 36px;
            line-height: 36px;
            font-size: 13px;
        }

        .el-menu-item {
            height: 36px;
            line-height: 36px;
            font-size: 13px;
        }

        .el-submenu .el-menu-item {
            height: 36px;
            line-height: 36px;
        }

        .el-menu--popup {
            padding: 0;
            margin: 0;
        }

        .el-submenu [class^=el-icon-] {
            font-size: 16px;
        }

        .el-menu-item [class^=el-icon-] {
            font-size: 16px;
        }

        .el-submenu__title:focus,
        .el-submenu__title:hover,
        .el-menu-item:focus,
        .el-menu-item:hover {
            background-color: rgba(116, 14, 24, .3) !important;
        }

        .el-menu-item.is-active {
            background-color: rgba(116, 14, 24, .3) !important;
        }

        .el-menu-vertical-demo:not(.el-menu--collapse) {
            width: 203px;
            min-height: 400px;
        }

        .el-container .el-main {
            padding: 0;
            position: relative;
            background: #fff;
        }

        .el-container .el-main .tabs {
            position: absolute;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
        }

        .el-container .el-main .el-tabs--border-card {
            background: transparent;
            border: 0;
            height: 100%;
        }

        .el-container .el-main .el-tabs--border-card>.el-tabs__header {
            background: #fff;
            padding-top: 0;
            border-bottom: 1px solid #e5e5e5;
        }

        .el-container .el-main .el-tabs--border-card>.el-tabs__header .el-tabs__item:not(.is-disabled):hover {
            background: #acb0b3;
            border-right-color: #acb0b3;
            border-left-color: #acb0b3;
            color: #fff;
        }

        .el-container .el-main .el-tabs--border-card>.el-tabs__header .el-tabs__item.is-active {
            background: #acb0b3;
            border-right-color: #acb0b3;
            border-left-color: #acb0b3;
            color: #fff;
            margin-top: -1px;
        }



        .el-container .el-main .el-tabs__content {
            height: calc(100% - 25px);
            padding: 0;
            background: #e7eded;
        }

        .el-container .el-main .frame {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 100%;
            overflow: hidden;
        }

        .el-container .el-footer {
            height: 26px !important;
            text-align: center;
            background: #000000;
            color: #808080;
            position: relative;
        }

        .el-container .el-footer .footer-right {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            line-height: 26px;
        }

        .el-container .el-footer .footer-right span {
            margin-right: 10px;
            color: #fff;
        }

        .el-container .el-footer .footer-right span .detail {
            text-shadow: 0px 0px 15px #ffbe05;
            color: #ffbe05;
        }

        .el-container .el-footer .footer-right .signal {
            display: inline-block;
            width: 10px;
            height: 10px;
            overflow: hidden;
            border-radius: 9px;
        }

        .ping-offLine {
            background: #cc1212;
        }

        .ping-onLine1 {
            background: #2cc522;
        }

        .ping-onLine2 {
            background: #d4931c;
        }

        .el-container .el-header .el-tabs__item {
            height: 30px;
            line-height: 26px;
        }

        .el-container .el-main .el-tabs__item {
            height: 24px;
            line-height: 22px;
        }

        .el-container .el-header .el-badge {
            line-height: normal;
        }

        .el-badge__content {
            background-color: #fff;
            color: #b91727;
            top: 4px;
            right: 12px;
            padding: 0 8px;
        }

        .el-popover__title {
            font-size: 12px;
            margin: 0;
            padding-bottom: 6px;
            padding-left: 5px;
            border-bottom: 1px solid #e5e5e5;
        }

        .bell {
            font-size: 12px;
            padding: 4px 0;
            border-bottom: 1px solid #e5e5e5;
            cursor: pointer;
        }

        .bell:hover {
            background: #fafafa;
        }

        .bell .bell-content {
            text-overflow: -o-ellipsis-lastline;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            color: #000;
            padding: 0 5px;
        }

        .bell .bell-date {
            text-align: right;
            padding: 0 5px;
        }

        .el-popover {
            padding: 12px 0 0 0;
        }

        .twinkling {
            -webkit-animation: twinkling 1.2s ease-out infinite alternate;
            animation: twinkling 1.2s ease-out infinite alternate;
        }

        @-webkit-keyframes twinkling {

            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        @keyframes twinkling {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        .fun-button button {
            padding: 7px 10px;
        }

        .el-dropdown {
            font-size: 12px;
            color: #fff;
        }

        .loginOut {
            color: #b91727;
        }

        .loginOut:hover {
            color: #b91727 !important;
        }

        .dropdown_button img {
            width: 16px;
            vertical-align: text-top;
            margin-right: 10px;
        }

        .page-lock {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            z-index: 999999;
            background: rgba(0, 0, 0, .8)
        }

        .page-lock .lock {
            position: absolute;
            left: 50%;
            top: 30%;
            transform: translate(-50%, -50%);
        }

        .page-lock .img {
            text-align: center;
        }

        .page-lock .img img {
            width: 160px;
        }

        .page-lock .close {
            position: absolute;
            right: -32px;
            bottom: 0;
            width: 28px;
            height: 28px;
            line-height: 24px;
            text-align: center;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
        }

        .page-lock .close img {
            width: 20px;
            vertical-align: middle;
        }

        .el-menu--collapse {
            width: 25px;
        }

        .icon-arrow- {
            display: inline-block;
            font-size: 12px;
            transition: all .5s linear;
        }

        .arrow-to-right {
            transform: rotateY(0);
        }

        .arrow-to-left {
            transform: rotateY(180deg);
        }

        .err-log {
            white-space: pre;
        }

        .err-note {
            color: #b91727;
        }

        .update {
            width: 100%;
            height: 300px;
            background: transparent;
            padding: 20px;
        }

        .update-title {
            font-weight: 700;
            font-size: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e5e5;
        }

        .update-info {
            padding: 10px 0;
            height: calc(100% - 40px - 38px);
            color: #8b8b8b;
            white-space: pre-line;
            line-height: 30px;
            overflow-y: auto;
        }

        #layui-layer100001 .layui-layer-title {
            background-color: initial !important;
        }

        #layui-layer100001 .layui-layer-close1 {
            color: #000 !important;
        }

        .layui-layer-max:before {
            content: "";
        }

        .el-icon-minus:before {
            content: "";
        }

        .layui-layim-chat .layui-layer-title {
            background-color: #F8F8F8 !important;
        }

        .form {
            padding: 20px 20px 20px 0;
        }

        .header {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            overflow: hidden;
            display: inline-block;
            margin-top: -7px;
            cursor: pointer;
            position: relative;
        }

        .header img {
            width: 100%;
            height: 100%;
        }

        .updatePwd {
            margin-left: 20px;
            font-size: 13px;
            color: #237ca7;
            cursor: pointer;
        }

        .fileStyle {
            position: absolute;
            top: 0;
            left: 0;
            width: 40px;
            height: 40px;
            opacity: 0;
        }

        .load-progress {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10086;
            width: 350px;
            margin-top: -23px;
            white-space: pre;
            text-align: center;
            line-height: 10px;
        }

        .progress-line {
            background: linear-gradient(to right, rgba(185, 23, 39, 0), rgba(185, 23, 39, .3) 50%, rgb(185, 23, 39));
            width: 0;
            height: 10px;
            border-radius: 100px;
        }

        .about>div {
            position: relative;
        }

        .about .label {
            height: 30px;
            line-height: 30px;
            width: 80px;
            position: absolute;
            left: 0;
            top: 0;
        }

        .about .value {
            padding-left: 80px;
            line-height: 30px;
        }

        .about .desc {
            padding: 10px 0;
            line-height: 30px;
            border-top: 1px solid #e3e3e3;
            margin-top: 10px;
        }

        .downloadPlugin {
            height: 350px;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div id="app" hidden>

        <el-container v-cloak>
            <el-header>
                <div class="top-drag"></div>
                <div class="row-1">
                    <div class="logo">
                        <img src="image/logo.png" />
                        <span>福路德信息化平台</span>
                    </div>
                    <div class="system-operation">
                        <div class="item" @click="showIM">
                            <el-badge :value="unReadCount" :max="99">
                                <i class="el-icon-s-comment" style="font-size: 22px;"></i>
                            </el-badge>
                        </div>

                        <div class="item img">
                            <el-dropdown placement="bottom" trigger="click" @command="handleCommand">
                                <div trigger="click">
                                    <img :src="setHeaderImg(userInfo.HeadImg)" />
                                    <span>{{userName}}</span>
                                    <i class="el-icon-arrow-down"></i>
                                </div>
                                <el-dropdown-menu slot="dropdown" style="width: 140px;">
                                    <el-dropdown-item class="dropdown_button" command="个人信息"><img
                                            src="image/personal.png" />个人信息</el-dropdown-item>
                                    <el-dropdown-item class="dropdown_button" command="锁屏"><img
                                            src="image/lock2.png" />锁屏</el-dropdown-item>
                                    <el-dropdown-item class="dropdown_button loginOut" command="注销"><img
                                            src="image/loginOut.png" />注销</el-dropdown-item>
                                </el-dropdown-menu>
                            </el-dropdown>
                        </div>
                        <div class="item">
                            <el-dropdown placement="bottom" trigger="click" @command="handleCommand">
                                <div trigger="click">
                                    <i class="iconfont icon-menu"></i>
                                </div>
                                <el-dropdown-menu slot="dropdown" style="width: 140px;">
                                    <el-dropdown-item class="dropdown_button" command="软件更新"><img
                                            src="image/update.png" />软件更新</el-dropdown-item>
                                    <el-dropdown-item class="dropdown_button" command="插件下载"><img
                                            src="image/plugin.png" />插件下载</el-dropdown-item>
                                    <el-dropdown-item class="dropdown_button" command="调试模式"><img
                                            src="image/debugger.png" />{{ifDebugger?'关闭调试':'开启调试'}}</el-dropdown-item>
                                    <el-dropdown-item class="dropdown_button" command="报错日志"><img
                                            src="image/log.png" />报错日志</el-dropdown-item>
                                    <el-dropdown-item class="dropdown_button" command="关于软件"><img
                                            src="image/aboutapp.png" />关于软件</el-dropdown-item>
                                </el-dropdown-menu>
                            </el-dropdown>
                        </div>
                        <div class="item" @click="min">
                            <i class="iconfont icon-suoxiao1"></i>
                        </div>
                        <div class="item" @click="toggleWinSize">
                            <i class="iconfont icon-suoxiao" style="font-size:14px;"></i>
                        </div>
                        <div class="item" @click="close">
                            <i class="iconfont icon-close" style="font-size:13px;"></i>
                        </div>
                    </div>
                </div>
                <div class="row-2">
                    <el-tabs class="tabs-padding" type="border-card" v-model="categoryActive"
                        @tab-click="categoryToggle">
                        <el-tab-pane v-for="(row,index) in categoryList" :name="row.Id + '_' + row.Name">
                            <span slot="label"><i class="iconfont" :class="row.ImageUrl"
                                    style="margin-right:10px;font-size:17px;"></i>{{row.Name}}</span>
                        </el-tab-pane>
                    </el-tabs>
                    <!-- <div class="calendar"></div> -->
                </div>
                <div class="row-3">
                    <div style="float:left;line-height: 28px;">
                        <div class="tree-search">
                            <el-button type="text" @click="toggleTree" style="padding:0;">
                                <i class="iconfont icon-arrow-"
                                    :class="!isCollapse?'arrow-to-left':'arrow-to-right'"></i>
                            </el-button>
                            <el-button type="text" icon="el-icon-d-caret" v-show="showIcon" @click="toggleOpen">伸缩
                            </el-button>
                            <div class="search-text" v-show="showIcon">
                                <input type="text" v-model="searchKey" />
                                <el-button type="text" icon="el-icon-search" @click="searchMenu"></el-button>
                            </div>
                        </div>
                    </div>
                    <el-button-group class="fun-button">
                        <el-button @click="dealTabs(1)">刷新页签</el-button>
                        <el-button @click="dealTabs(2)">关闭当前页签</el-button>
                        <el-button @click="dealTabs(3)">关闭所有页签</el-button>
                        <el-button @click="dealTabs(4)">关闭其他页签</el-button>
                    </el-button-group>

                </div>
            </el-header>
            <el-container>
                <el-aside>
                    <div class="tree-list">
                        <menu-template :collapse="isCollapse" :openeds="openeds" :menu_data="nodeList"
                            @item-click="treeSelect"></menu-template>
                    </div>
                </el-aside>
                <el-container>
                    <el-main>
                        <div class="tabs">
                            <el-tabs type="border-card" v-model="rightTabsActive" @tab-remove="rightTabsRemove"
                                @tab-click="openDevTools">
                                <el-tab-pane label="首页" name="首页">
                                    <div class="frame">
                                        <webview
                                            :src="'http://' + config.Http_config.ip + ':' + config.Http_config.port + '/index.html'"
                                            style="width:100%;height:100%" nodeintegration></webview>
                                    </div>
                                </el-tab-pane>
                                <el-tab-pane closable v-for="(row,index) in rightTabsList"
                                    :key="row.Id + '_' + row.Name + '_' + row.keyCode" :label="row.Name"
                                    :name="row.Id + '_' + row.Name + '_' + row.keyCode">
                                    <div class="frame">
                                        <webview :src="row.NavigateUrl" style="width:100%;height:100%" nodeintegration>
                                        </webview>
                                    </div>
                                </el-tab-pane>
                            </el-tabs>
                            <div class="load-progress" v-if="showloadPercentage">
                                <div class="progress-line" :style="{width:loadPercentage+ '%'}"></div>
                                <div><span>{{loadPercentage}}%</span></div>
                            </div>
                        </div>
                    </el-main>
                    <el-footer>
                        <div style="line-height: 26px;">宁波市汇智云创信息科技有限公司技术支持</div>
                        <div class="footer-right">
                            <span class="ip_port">当前登录
                                <span class="detail">【{{localIP}}】</span>
                            </span>
                            <span>当前网络</span>
                            <span class="signal" :class="pingStatus"></span>
                        </div>
                    </el-footer>
                </el-container>
            </el-container>
        </el-container>

        <transition name="el-fade-in" v-cloak>
            <div class="page-lock" v-if="pageLock">
                <div class="lock">
                    <div class="img">
                        <img src="image/lock1.png" />
                    </div>
                    <div style="margin-top:30px;">
                        <el-input type="password" placeholder="请输入解锁密码" v-model="lockPassword"
                            @keyup.enter.native="unlock">
                            <template slot="append">
                                <el-button type="primary" @click="unlock">解锁</el-button>
                            </template>
                        </el-input>
                    </div>
                    <div class="close" @click="close">
                        <a title="退出软件"><img src="image/loginOut-lock.png" /></a>

                    </div>
                </div>
            </div>
        </transition>


        <el-dialog title="错误日志" width="80%" :visible.sync="showErrLog">
            <el-table :data="errData" max-height="500">
                <el-table-column>
                    <template slot="header" slot-scope="scope">

                        <el-form :inline="true" :model="logSearch" class="demo-form-inline">
                            <el-form-item label="开始时间" style="margin: 0;">
                                <el-date-picker type="datetime" value-format="yyyy-MM-dd HH:mm:ss" placeholder="选择日期"
                                    v-model="logSearch.logDate1">
                            </el-form-item>
                            <el-form-item label="结束时间" style="margin: 0;">
                                <el-date-picker type="datetime" value-format="yyyy-MM-dd HH:mm:ss" placeholder="选择日期"
                                    v-model="logSearch.logDate2">
                            </el-form-item>
                            <el-form-item style="margin: 0;">
                                <el-button type="primary" @click="changeErrLogDate">查询</el-button>
                            </el-form-item>
                        </el-form>


                    </template>
                    <template slot-scope="scope">
                        <div class="err-log">{{scope.row.error}}</div>
                        <div class="err-note">
                            <div><b>{{scope.row.time}}</b></div>
                            <div><b>{{decodeURI(scope.row.url)}}</b></div>
                        </div>

                    </template>
                </el-table-column>
            </el-table>
        </el-dialog>


        <el-dialog title="软件更新" width="526px" :visible.sync="ifUpdate">
            <div class="update">
                <div class="update-title">发现新版本({{updateInfo.F_Ver}})</div>
                <div class="update-info">
                    <div>{{updateInfo.FRemarks}}</div>
                </div>
                <div class="update-button">
                    <el-row :gutter="20" v-show="!isUpdateNow">
                        <el-col :span="12" style="text-align:center;">
                            <el-button block type="primary" style="width: 150px;" @click="updateAPP">更新
                            </el-button>
                        </el-col>
                        <el-col :span="12" style="text-align:center;">
                            <el-button block style="width: 150px;" @click="cancelUpdate">取消
                            </el-button>
                        </el-col>
                    </el-row>
                    <el-progress size="mini" :percentage="percentage" v-show="isUpdateNow"></el-progress>
                </div>
            </div>
        </el-dialog>

        <el-dialog title="个人信息" width="526px" :visible.sync="showUserInfo">
            <el-form ref="form" class="form" :model="userInfo" label-width="100px">
                <el-form-item label="头像">
                    <div class="header">
                        <img :src="setHeaderImg(userInfo.HeadImg)" />
                        <input type="file" id="newFile" name="newFile" class="fileStyle" onchange="uploadNewFile()" />
                    </div>
                </el-form-item>
                <el-form-item label="账号">
                    <el-input v-model="userInfo.UserCode" readonly></el-input>
                </el-form-item>
                <el-form-item label="姓名">
                    <el-input v-model="userInfo.UserName"></el-input>
                </el-form-item>
                <el-form-item label="密码">
                    <div><span>******</span><span class="updatePwd" @click="ifUpdatePwd = true;">修改</span></div>
                </el-form-item>
                <el-form-item>
                    <el-button type="primary" @click="onSubmitUserInfo">保存</el-button>
                    <el-button @click="showUserInfo = false;">关闭</el-button>
                </el-form-item>
            </el-form>
        </el-dialog>

        <el-dialog title="密码修改" width="326px" :visible.sync="ifUpdatePwd">
            <el-form class="form" label-width="100px">
                <el-form-item label="旧密码">
                    <el-input type="password" v-model="oldPassWord"></el-input>
                </el-form-item>
                <el-form-item label="新密码">
                    <el-input type="password" v-model="newPassWord1"></el-input>
                </el-form-item>
                <el-form-item label="确认新密码">
                    <el-input type="password" v-model="newPassWord2"></el-input>
                </el-form-item>
                <el-form-item>
                    <el-button type="primary" @click="onSubmitPwd">保存</el-button>
                    <el-button @click="ifUpdatePwd = false;">关闭</el-button>
                </el-form-item>
            </el-form>
        </el-dialog>


        <el-dialog title="关于软件" width="450px" :visible.sync="showAboutAPP">
            <div class="about">
                <div style="line-height: 50px;">
                    <img src="image/logo_small.png" />
                    <b>{{package.description}}</b>
                </div>
                <div>
                    <div class="label">当前版本：</div>
                    <div class="value"><b>{{package.version}}---{{operatingSystem}}</b></div>
                </div>
                <div>
                    <div class="label">提交时间：</div>
                    <div class="value"><b>{{package.buildDate}}</b></div>
                </div>
                <!-- <div>
                    <div class="label">软件类型：</div>
                    <div class="value">
                        <b>试用版(剩余29天)</b>
                        <el-link type="primary" style="margin-top: -3px;">前往激活</el-link>
                    </div>
                </div> -->
                <div>
                    <div class="label">机器编码：</div>
                    <div class="value">{{machineId}}</div>
                </div>
                <div class="desc">
                    &nbsp;&nbsp;&nbsp;&nbsp;福路德信息化平台采用自主研发的汇创H6开发系统搭建完成，汇创H6是一套可灵活配置表单、报表、接口、和页面的开发系统，包含了丰富的表单控件和各类插件，采用了Nodejs+Electron技术支撑整个
                    软件平台，<br>
                    有任何需求或问题请联系：13586836674（金先生）
                </div>
            </div>
        </el-dialog>


        <el-dialog title="插件下载" width="450px" :visible.sync="showPluginDownload">
            <div class="downloadPlugin">
                <el-row :gutter="6" style="padding:10px;background:#e4e3e3">
                    <el-col :span="8">文件名称</el-col>
                    <el-col :span="3">大小</el-col>
                    <el-col :span="10">&nbsp;</el-col>
                    <el-col :span="3">下载</el-col>
                </el-row>
                <el-row :gutter="6" style="padding-top:10px;">
                    <el-col :span="8">报表打印控件.exe</el-col>
                    <el-col :span="3">2.12M</el-col>
                    <el-col :span="10"><span style="float:left;height: 1px;width:1px;display:block;">&nbsp;</span>
                        <el-progress v-show="downloadList[0].show" :percentage="downloadList[0].percentage"
                            :text-inside="true" :show-text="false" style="margin-top:5px;width:80%"></el-progress>
                    </el-col>
                    <el-col :span="3"><i class="el-icon-download"
                            @click="downloadFile('/assets/plugins/print/CLodop_Setup_for_Win32NT.exe','.exe',0)"></i>
                    </el-col>
                </el-row>
            </div>


        </el-dialog>


    </div>

    <audio id="msg_mp3" hidden src="assets/utils/Baidu-TTS.mp3"></audio>
</body>
<script>
    const { ipcRenderer } = require('electron')
    const session = require('electron').remote.session
    const ping = require('ping');
    const { SystemModules, SelfModules } = require(ipcRenderer.sendSync('getRootPath') + '/assembly/RequireHelper')
    const { post } = SelfModules('httpHelper')
    const layimConfig = SelfModules('IMHelper')
    const Config = require(ipcRenderer.sendSync('getRootPath') + '/config/config.json')
    const package = require(ipcRenderer.sendSync('getRootPath') + '/package.json')
    const { machineIdSync } = require('node-machine-id')
    const { downFile } = SelfModules('downLoadFileHelper')

    let winSizeType = 1;
    let lockTime = new Date().getTime();

    //设置cookie到webview
    const cookie = [{
        url: 'http://' + Config.Http_config.ip + ':' + Config.Http_config.port,
        name: 'UserID',
        value: localStorage.getItem("UserID").toString()
    }, {
        url: 'http://' + Config.Http_config.ip + ':' + Config.Http_config.port,
        name: 'UserCode',
        value: localStorage.getItem("UserCode")
    }, {
        url: 'http://' + Config.Http_config.ip + ':' + Config.Http_config.port,
        name: 'UserName',
        value: localStorage.getItem("UserName")
    }];
    for (var i in cookie) {
        session.defaultSession.cookies.set(cookie[i], (error) => {
            if (error) console.error(error);
        });
    }

    //软件更新检测相关
    ipcRenderer.on("message", (event, text) => {
        console.log(text)
        if (text == 'isUpdateNow') {
            ipcRenderer.send('updateNow')
        }
    });

    //监听软件更新下载进度
    ipcRenderer.on("downloadProgress", (event, progressObj) => {
        vm.isUpdateNow = true;
        vm.percentage = parseInt(progressObj.percent);
    });

    //写入报错信息
    ipcRenderer.on("errorWrite", (event, text) => {
        writeFile(text);
    });


    //软件被点击 记录点击事件
    ipcRenderer.on("appClick", (event, text) => {
        console.warn('webview点击屏幕')
        lockTime = new Date().getTime();
    });

    //新增页签功能
    ipcRenderer.on("addMainTab", (event, text) => {
        vm.treeSelect({
            Id: text.Id,
            Name: text.Name,
            NavigateUrl: 'http://' + Config.Http_config.ip + ':' + Config.Http_config.port + text.NavigateUrl
        });
    });
    //系统底层级消息提示
    ipcRenderer.on("messageBox", (event, text) => {
        layer.msg(text);
    });



    $(function () {
        $('#app').show();
        $('body').click(function () {
            lockTime = new Date().getTime();
        })

        setTimeout(function () {
            //初始化layim
            layimConfig.config();
        }, 100);
    })

    function getPostObj() {
        return post;
    }

    //element ui 使用最小尺寸样式
    Vue.prototype.$ELEMENT = { size: 'mini' }


    const vm = new Vue({
        el: '#app',
        data: {
            showIcon: true,
            isCollapse: false,
            openeds: [],
            totalList: [],
            originTotalList: [],
            categoryList: [],
            categoryActive: '',
            nodeList: [],
            rightTabsList: [],
            rightTabsActive: '首页',
            searchKey: '',
            currentTypeId: 0,
            config: Config,
            package: package,
            operatingSystem: process.arch,
            localIP: getIPAdress(),
            machineId: machineIdSync(),
            pingStatus: '',
            ifDebugger: false,
            pageLock: false,
            lockPassword: '',
            userName: localStorage.getItem("UserCode"),
            showErrLog: false,
            errData: [],
            logSearch: {
                logDate1: getFormatDate().split(' ')[0] + ' 00:00:00',
                logDate2: getFormatDate().split(' ')[0] + ' 23:23:59'
            },
            ifUpdate: false,
            updateInfo: [],
            isUpdateNow: false,
            percentage: 0,
            showUserInfo: false,
            userInfo: '',
            ifUpdatePwd: false,
            oldPassWord: '',
            newPassWord1: '',
            newPassWord2: '',
            loadPercentage: 0,
            showloadPercentage: false,
            showAboutAPP: false,
            showPluginDownload: false,
            downloadList: [{
                show: false,
                percentage: 0
            }],
            unReadCount:0
        },
        created: function () {
            let that = this;
            let host = Config.Http_config.ip;
            //定时检测ping值并设置颜色显示
            let getPing = function () {
                ping.promise.probe(host)
                    .then(function (res) {
                        if (typeof (res.time) == 'string') {
                            that.pingStatus = 'ping-offLine';
                        } else if (typeof (res.time) == 'number') {
                            if (0 < res.time && res.time < 200) {
                                that.pingStatus = 'ping-onLine1';
                            } else {
                                that.pingStatus = 'ping-onLine2';
                            }
                        } else {
                            that.pingStatus = 'ping-offLine';
                        }
                    });
            }
            setInterval(getPing, 2000)
            getPing();

            //获取用户菜单
            post({
                path: '/Frame/SqlData'
            }, {
                    cmdname: 'getMainMenuByUser',
                    userId: localStorage.getItem("UserID")
                }, (ret) => {
                    let data = JSON.parse(ret);
                    if (data.status == 200) {
                        let totalList = data.data.ds
                        for (let i in totalList) {
                            if (totalList[i].NavigateUrl) {
                                totalList[i].NavigateUrl = 'http://' + Config.Http_config.ip + ':' + Config.Http_config.port + totalList[i].NavigateUrl;
                            }
                        }
                        that.totalList = totalList;
                        for (let i in that.totalList) {
                            if (that.totalList[i].ParentID == 1) {
                                that.categoryList.push(that.totalList[i]);
                            }
                        }
                        that.originTotalList = JSON.parse(JSON.stringify(that.totalList));
                        if (that.categoryList.length > 0) {
                            that.categoryActive = that.categoryList[0].Id + '_' + that.categoryList[0].Name;
                            that.currentTypeId = that.categoryList[0].Id;
                            that.setSubClass(that.categoryList[0].Id);
                        }
                        //业务流禁用权限功能表
                        var unWorkRoleList = data.data.ds1;
                        ipcRenderer.send('setUnWrokRoleList', unWorkRoleList);
                        //表单功能权限列表
                        var billRoleList = data.data.ds2;
                        ipcRenderer.send('setBillRoleList', billRoleList);

                    } else {
                        layer.msg('接口数据异常!请稍后再试');
                    }
                }, (err) => {

                })

            //获取用户个人信息
            post({
                path: '/Frame/SqlData'
            }, {
                    cmdname: 'GetUserDetail',
                    userId: localStorage.getItem("UserID")
                }, (ret) => {
                    let data = JSON.parse(ret);
                    if (data.status == 200) {
                        that.userInfo = data.data.ds[0];
                    } else {
                        layer.msg('接口数据异常!请稍后再试');
                    }
                }, (err) => {

                })

        },
        methods: {
            //头像图片显示
            setHeaderImg(imgUrl) {
                if (imgUrl) {
                    return imgUrl;
                } else {
                    return 'image/header.png'
                }
            },
            //修改用户密码
            onSubmitPwd() {
                let that = this;
                if (!that.oldPassWord) {
                    layer.msg('请填写原密码!');
                    return false;
                }
                if (!that.newPassWord1) {
                    layer.msg('请填写新密码!');
                    return false;
                }
                if (that.newPassWord1 != that.newPassWord2) {
                    layer.msg('两次输入的密码不一致!');
                    return false;
                }
                post({
                    path: '/Frame/SqlData'
                }, {
                        cmdname: 'updateUserPwd',
                        userId: localStorage.getItem("UserID"),
                        oldPwd: that.oldPassWord,
                        newPwd: that.newPassWord1
                    }, (ret) => {
                        debugger;
                        let data = JSON.parse(ret);
                        if (data.status == 200) {
                            if (data.data.ds[0].status == 200) {
                                that.ifUpdatePwd = false;
                                layer.alert('密码修改成功 点击确定按钮重新登录!', {
                                    closeBtn: 0,
                                    btn: ['确定'],
                                    btn1: function () {
                                        localStorage.removeItem("userLoginPwd");
                                        localStorage.removeItem("userLoginName")
                                        ipcRenderer.send('redirectLogin');
                                    }
                                })
                            } else {
                                layer.msg(data.data.ds[0].msg);
                            }

                        } else {
                            layer.msg('接口数据异常!请稍后再试');
                        }
                    }, (err) => {

                    })

            },
            //修改个人资料
            onSubmitUserInfo() {
                let that = this;
                if (!that.userInfo.UserName) {
                    layer.msg('请填写用户昵称!');
                    return false;
                }
                post({
                    path: '/Frame/SqlData'
                }, {
                        cmdname: 'updateUserDetail',
                        userId: localStorage.getItem("UserID"),
                        headImg: that.userInfo.HeadImg,
                        username: that.userInfo.UserName
                    }, (ret) => {
                        let data = JSON.parse(ret);
                        if (data.status == 200) {
                            layer.msg('保存成功');
                        } else {
                            layer.msg('接口数据异常!请稍后再试');
                        }
                    }, (err) => {

                    })
            },
            //打开开发者调试工具
            openDevTools(e) {
                let that = this;
                if (that.ifDebugger) {
                    $(e.$el).find('webview')[0].getWebContents().openDevTools();
                }
            },
            //index:1---刷新 2---关闭当前 3---关闭所有 4---关闭其他
            dealTabs(index) {
                let that = this;
                if (index == 1) {
                    $('#pane-' + that.rightTabsActive).find('webview')[0].reload();
                } else if (index == 2) {
                    if (that.rightTabsActive == '首页') {
                        layer.msg('首页不允许关闭!');
                        return false;
                    }
                    that.rightTabsRemove(that.rightTabsActive);
                } else if (index == 3) {
                    that.rightTabsActive = '首页';
                    that.rightTabsList = [];
                } else if (index == 4) {
                    this.rightTabsList = that.rightTabsList.filter(tab => (tab.Id + '_' + tab.Name + '_' + tab.keyCode) === that.rightTabsActive);
                }
            },
            downloadFile(url, ext, index) {
                let that = this;
                const { dialog } = require('electron').remote;
                let saveFilePath = dialog.showSaveDialog({});
                if (saveFilePath) {
                    saveFilePath = saveFilePath + ext;
                    that.downloadList[index].show = true;
                    downFile({
                        remoteFile: 'http://' + Config.Http_config.ip + ':' + Config.Http_config.port + url,
                        localFile: saveFilePath,
                        onProgress: function (received, total) {
                            var percentage = (received * 100) / total;
                            that.downloadList[index].percentage = percentage;
                            if (percentage >= 100) {
                                layer.msg('下载完成');
                                that.downloadList[index].show = false;
                                that.downloadList[index].percentage = 0;
                            }
                        }
                    })
                }


            },
            //重置左侧树列表
            setSubClass(id) {
                let that = this;
                that.nodeList = [];
                that.openeds = [];
                if (that.searchKey == '') {
                    let repeatNode = (id) => {
                        let node = [];
                        for (let i in that.totalList) {
                            if (id == that.totalList[i].ParentID) {
                                that.totalList[i].node = repeatNode(that.totalList[i].Id);
                                node.push(that.totalList[i]);
                            }
                        }
                        return node;
                    }
                    that.nodeList = repeatNode(id);
                }
                else {
                    let node = [];
                    for (let i in that.originTotalList) {
                        if (that.originTotalList[i].Name.indexOf(that.searchKey) >= 0) {
                            that.originTotalList[i].node = [];
                            let isLeaf = true;
                            for (let j in that.originTotalList) {
                                if (that.originTotalList[j].ParentID == that.originTotalList[i].Id) {
                                    isLeaf = false;
                                    break;
                                }
                            }
                            if (isLeaf) {
                                node.push(that.originTotalList[i]);
                            }


                        }
                    }
                    that.nodeList = node;
                }

                for (let i in that.nodeList) {
                    that.openeds.push('self' + that.nodeList[i].Id);
                }
            },
            //点击左侧树
            treeSelect(row) {
                let that = this;
                let row_new = JSON.parse(JSON.stringify(row))
                row_new.keyCode = new Date().getTime();
                if (that.rightTabsList.length >= 10) {
                    layer.msg('当前窗口打开过多,请关闭部分窗口后重试!');
                } else {

                    let ifok = false;

                    that.loadPercentage = 0;
                    that.showloadPercentage = true;

                    let timeout = 1;
                    let getLoadProgress = () => {
                        if (!ifok) {
                            if (that.loadPercentage < 50) {
                                timeout = 10;
                            }
                            if (that.loadPercentage < 70 && that.loadPercentage >= 50) {
                                timeout = 100;
                            }
                            if (that.loadPercentage < 80 && that.loadPercentage >= 70) {
                                timeout = 500;
                            }
                            if (that.loadPercentage < 90 && that.loadPercentage >= 80) {
                                timeout = 2000;
                            }
                            if (that.loadPercentage < 95 && that.loadPercentage >= 90) {
                                timeout = 5000;
                            }
                            if (that.loadPercentage < 98 && that.loadPercentage >= 95) {
                                timeout = 20000;
                            }
                            if (that.loadPercentage < 100 && that.loadPercentage >= 98) {
                                timeout = 99999999999999999;
                            }
                        }

                        if (that.loadPercentage >= 100) {

                            let webview = $('#pane-' + that.rightTabsActive).find('webview');
                            setTimeout(() => {
                                that.showloadPercentage = false;
                                webview.css({ 'opacity': 1 });
                            }, 800)

                            return false;
                        }
                        that.loadPercentage += 1
                        setTimeout(() => {
                            getLoadProgress();
                        }, timeout)

                    }
                    getLoadProgress();

                    that.rightTabsActive = row_new.Id + '_' + row_new.Name + '_' + row_new.keyCode;
                    that.rightTabsList.push(row_new);

                    that.$nextTick(() => {
                        let webview = $('#pane-' + that.rightTabsActive).find('webview');
                        webview.css({ 'opacity': 0 });
                        webview[0].addEventListener('dom-ready', () => {
                            timeout = 1;
                            ifok = true;

                        })
                    })
                }
            },
            //左侧树收起/展开
            toggleOpen() {
                let that = this;
                if (!that.openeds.length) {
                    that.openeds = [];
                    for (let i in that.nodeList) {
                        that.openeds.push('self' + that.nodeList[i].Id);
                    }
                } else {
                    that.openeds = [];
                }
            },
            //关闭webview页签
            rightTabsRemove(targetName) {
                let tabs = this.rightTabsList;
                let activeName = this.rightTabsActive;
                if (activeName === targetName) {
                    tabs.forEach((tab, index) => {
                        if ((tab.Id + '_' + tab.Name + '_' + tab.keyCode) === targetName) {
                            let nextTab = tabs[index + 1] || tabs[index - 1];
                            if (nextTab) {
                                activeName = nextTab.Id + '_' + nextTab.Name + '_' + nextTab.keyCode;
                            } else {
                                activeName = '首页'
                            }
                        }
                    });
                }
                this.showloadPercentage = false;
                this.rightTabsActive = activeName;
                this.rightTabsList = tabs.filter(tab => (tab.Id + '_' + tab.Name + '_' + tab.keyCode) !== targetName);

            },
            //顶部大分类切换
            categoryToggle(e) {
                let that = this;
                that.searchKey = "";
                let name = e.name;
                let id = parseInt(name.split('_')[0]);
                that.currentTypeId = id;
                that.setSubClass(id)
            },
            //左侧树搜索
            searchMenu() {
                let that = this;
                that.setSubClass(that.currentTypeId);
            },
            //软件最小化
            min() {
                ipcRenderer.send('minWindow');
            },
            //切换软件显示尺寸
            toggleWinSize() {
                if (winSizeType == 1) {
                    winSizeType = 0;
                    ipcRenderer.send('toggleWindow_min');
                } else {
                    winSizeType = 1;
                    ipcRenderer.send('toggleWindow_max');
                }
            },
            //退出软件
            close() {
                let exitLayer = layer.confirm('确定退出' + package.description + '?', {
                    title: '提示',
                    closeBtn: 0,
                    btn: ['确认', '取消'] //按钮
                }, () => {
                    ipcRenderer.sendSync('quitApp');
                }, () => {
                    layer.close(exitLayer);
                });

            },
            //左侧树的显示与隐藏
            toggleTree() {
                let that = this;
                that.showIcon = !that.showIcon;
                setTimeout(() => {
                    that.isCollapse = !that.showIcon;
                }, 100)
            },
            //显示报错日志
            changeErrLogDate() {
                let that = this;
                let date1 = that.logSearch.logDate1;
                let date2 = that.logSearch.logDate2;
                if (date1.split(' ')[0] == date2.split(' ')[0]) {
                    readFile(date1.split(' ')[0] + '.txt', (content) => {
                        if (content) {
                            let newArray = [];
                            let contentArray = content.split('----hzyc----');
                            for (let i in contentArray) {
                                if (i != contentArray.length - 1) {
                                    let jsonContent = JSON.parse(contentArray[i]);
                                    if (new Date(date1) <= new Date(jsonContent.time) && new Date(date2) >= new Date(jsonContent.time)) {
                                        newArray.push(jsonContent);
                                    }

                                }
                            }
                            that.errData = newArray;
                        } else {
                            that.errData = [];
                        }

                    });
                } else {
                    let newArray = [];
                    let max = (new Date(date2.split(' ')[0]).getTime() - new Date(date1.split(' ')[0]).getTime()) / (1000 * 60 * 60 * 24)
                    let repeatDate = (x) => {
                        if (x > max) {
                            that.errData = newArray;
                        } else {
                            var fileName = getFormatDate(new Date(new Date(date1.split(' ')[0]).getTime() + (1000 * 60 * 60 * 24 * x))).split(' ')[0]
                            readFile(fileName + '.txt', (content) => {

                                if (content) {
                                    let contentArray = content.split('----hzyc----');
                                    for (let i in contentArray) {
                                        if (i != contentArray.length - 1) {
                                            let jsonContent = JSON.parse(contentArray[i]);
                                            if (new Date(date1) <= new Date(jsonContent.time) && new Date(date2) >= new Date(jsonContent.time)) {
                                                newArray.push(jsonContent);
                                            }

                                        }
                                    }

                                }
                                x++;
                                repeatDate(x)

                            });
                        }

                    }
                    repeatDate(0)
                }


            },
            //手动检测更新
            checkUpdate() {
                debugger;
                let that = this;
                post({
                    path: '/Frame/SqlData'
                }, {
                        cmdname: 'PC_FileList'
                    }, (result) => {
                        result = JSON.parse(result);
                        if (result.status == 200) {
                            let data = result.data;
                            if (data.ds[data.ds.length - 1].F_Ver != package.version) {
                                that.updateInfo = data.ds[data.ds.length - 1];
                                that.ifUpdate = true;
                                //需要更新,主进程检测更新

                            }
                        }
                    }, (err) => {

                    });
            },
            //更新软件
            updateAPP() {
                let that = this;
                ipcRenderer.send('update', 2);
            },
            //取消更新
            cancelUpdate() {
                let that = this;
                that.ifUpdate = false;

            },
            //软件右上角功能集合
            handleCommand(command) {
                let that = this;
                if (command == '注销') {
                    localStorage.removeItem("userLoginPwd");
                    localStorage.removeItem("userLoginName")
                    ipcRenderer.send('redirectLogin');
                } else if (command == '调试模式') {
                    if (!that.ifDebugger) {
                        ipcRenderer.send('openTool');
                    }
                    that.ifDebugger = !that.ifDebugger;
                } else if (command == '锁屏') {
                    that.pageLock = true;
                } else if (command == '报错日志') {
                    that.changeErrLogDate();
                    that.showErrLog = true;
                } else if (command == '软件更新') {
                    that.checkUpdate();
                } else if (command == '个人信息') {
                    that.showUserInfo = true;
                    that.oldPassWord = '';
                    that.newPassWord1 = '';
                    that.newPassWord2 = '';
                } else if (command == '关于软件') {
                    that.showAboutAPP = true;
                } else if (command == '插件下载') {
                    that.showPluginDownload = true;
                }

            },
            //锁机功能
            unlock() {
                let that = this;
                if (!that.lockPassword) {
                    layer.msg('请输入解锁密码!')
                    return false;
                }
                if (that.lockPassword == '123456') {
                    that.lockPassword = '';
                    that.pageLock = false;
                    lockTime = new Date().getTime();
                } else {
                    that.lockPassword = '';
                    layer.msg('解锁密码错误,请重新输入!')
                }
            },
            //显示聊天回话
            showIM() {
                layimConfig.showLayim();
            }
        }
    })

    var fileUploadData;
    var preFjPath = '';
    function uploadNewFile() {
        var curPath = $("#newFile").val();
        if (preFjPath == curPath) {
            return false;
        }
        preFjPath = curPath;
        var formId = 'jUploadForm' + 'newFile';  //file为input的id  
        var test1 = jQuery('#' + formId);
        if (test1.length > 0) {
            test1.remove();
        }
        $.ajaxFileUpload({
            type: 'POST',
            url: 'http://' + Config.Http_config.ip + ':' + Config.Http_config.port + '/Frame/uploadImgFile?dirName=userHeader',
            secureuri: false,
            fileElementId: 'newFile',
            dataType: 'json',
            success: function (datas, status) {
                preFjPath = '';
                var file = $("#newFile")
                file.after(file.clone().val(""));
                file.remove();
                debugger;
                if (datas.status == 200) {
                    vm.userInfo.HeadImg = 'http://' + Config.Http_config.ip + ':' + Config.Http_config.port + datas.data.origin;
                } else {
                    layer.msg('文件未上传!');
                }
            },
            error: function (data, status, e) {
                preFjPath = '';
                var file = $("#newFile")
                file.after(file.clone().val(""));
                file.remove();
                layer.msg('上传出错!');
            }
        });
    }

</script>

</html>